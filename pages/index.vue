<template>
  <div class="relative min-h-screen overflow-hidden bg-slate-950 text-slate-50">
    <div class="pointer-events-none absolute inset-x-0 top-0 h-[420px] bg-gradient-to-b from-primary/30 via-slate-900/40 to-transparent" />
    <div class="pointer-events-none absolute -top-20 left-1/2 hidden h-96 w-96 -translate-x-1/2 rounded-full bg-primary/30 blur-3xl lg:block" />
    <div class="pointer-events-none absolute -right-32 bottom-0 hidden h-[420px] w-[420px] rounded-full bg-fuchsia-500/20 blur-3xl lg:block" />

    <div class="relative mx-auto max-w-6xl px-4 pb-12 pt-24 sm:px-6 lg:px-8">
      <section class="flex flex-col gap-8 text-center lg:text-left">
        <span class="mx-auto inline-flex items-center gap-2 rounded-full border border-primary/40 bg-primary/10 px-4 py-1 text-xs font-semibold uppercase tracking-[0.35em] text-primary/80 lg:mx-0">
          {{ heroContent.eyebrow }}
        </span>
        <div class="space-y-6">
          <h1 class="text-4xl font-bold leading-tight text-white sm:text-5xl">
            {{ heroContent.title }}
          </h1>
          <p class="mx-auto max-w-2xl text-base text-slate-300 lg:mx-0">
            {{ heroContent.description }}
          </p>
        </div>
        <div class="flex flex-wrap justify-center gap-4 lg:justify-start">
          <NuxtLink
            :href="heroContent.primary.href"
            class="inline-flex items-center justify-center rounded-full bg-primary px-6 py-3 text-sm font-semibold text-slate-950 shadow-lg shadow-primary/40 transition hover:bg-primary/90"
          >
            {{ heroContent.primary.label }}
          </NuxtLink>
          <NuxtLink
            :href="heroContent.secondary.href"
            class="inline-flex items-center justify-center gap-2 rounded-full border border-white/10 bg-white/5 px-6 py-3 text-sm font-semibold text-white backdrop-blur transition hover:border-white/30 hover:bg-white/10"
            target="_blank"
            rel="noopener noreferrer"
          >
            {{ heroContent.secondary.label }}
            <span aria-hidden="true">‚Üí</span>
          </NuxtLink>
        </div>
        <div class="grid gap-6 sm:grid-cols-3">
          <div
            v-for="stat in heroStats"
            :key="stat.id"
            class="rounded-2xl border border-white/10 bg-white/5 p-5 text-left backdrop-blur"
          >
            <p class="text-3xl font-semibold text-white">
              {{ stat.value }}
            </p>
            <p class="mt-1 text-sm text-slate-400">
              {{ stat.label }}
            </p>
          </div>
        </div>
      </section>
    </div>

    <div
      id="latest"
      class="relative mx-auto mt-4 grid max-w-6xl gap-10 px-4 pb-24 sm:px-6 lg:grid-cols-[minmax(0,1fr)_320px] lg:px-8"
    >
      <div class="space-y-6">
        <div
          v-if="pending"
          class="grid gap-6 sm:grid-cols-2"
        >
          <div
            v-for="index in 4"
            :key="index"
            class="flex flex-col gap-6 rounded-3xl border border-white/5 bg-white/5 p-8 shadow-[0_25px_55px_-25px_rgba(15,23,42,0.65)] backdrop-blur-xl"
          >
            <div class="flex items-center gap-4">
              <div class="h-14 w-14 rounded-2xl bg-white/10" />
              <div class="space-y-3">
                <div class="h-3 w-32 rounded-full bg-white/10" />
                <div class="h-3 w-24 rounded-full bg-white/10" />
              </div>
            </div>
            <div class="space-y-3">
              <div class="h-3 w-3/4 rounded-full bg-white/10" />
              <div class="h-3 w-2/3 rounded-full bg-white/10" />
              <div class="h-3 w-full rounded-full bg-white/10" />
            </div>
            <div class="mt-auto flex gap-3">
              <div class="h-7 w-28 rounded-full bg-white/5" />
              <div class="h-7 w-28 rounded-full bg-white/5" />
            </div>
          </div>
        </div>

        <template v-else>
          <PostCard
            v-for="post in posts"
            :key="post.id"
            :post="post"
            :default-avatar="defaultAvatar"
            :reaction-emojis="reactionEmojis"
            :reaction-labels="reactionLabels"
          />
        </template>
      </div>

      <div class="hidden lg:block">
        <div class="sticky top-32 flex flex-col gap-6 rounded-3xl border border-white/5 bg-white/5 p-6 backdrop-blur-xl">
          <header class="space-y-2">
            <p class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">
              {{ sidebarContent.title }}
            </p>
            <h2 class="text-2xl font-semibold text-white">
              {{ sidebarContent.subtitle }}
            </h2>
          </header>
          <div class="space-y-4">
            <SidebarWidget
              v-for="widget in sidebarContent.widgets"
              :key="widget.id"
              :widget="widget"
            />
          </div>
        </div>
      </div>
    </div>

    <div class="mx-auto mb-16 mt-6 max-w-6xl px-4 sm:px-6 lg:hidden">
      <div class="rounded-3xl border border-white/5 bg-white/5 p-6 backdrop-blur-xl">
        <header class="space-y-2 text-center">
          <p class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">
            {{ sidebarContent.title }}
          </p>
          <h2 class="text-2xl font-semibold text-white">
            {{ sidebarContent.subtitle }}
          </h2>
        </header>
        <div class="mt-6 grid gap-4 sm:grid-cols-2">
          <SidebarWidget
            v-for="widget in sidebarContent.widgets"
            :key="widget.id"
            :widget="widget"
          />
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed } from "vue";
import { callOnce } from "#imports";
import { usePostsStore } from "~/composables/usePostsStore";
import type { ReactionType } from "~/lib/mock/blog";
import type { SidebarWidgetData } from "~/components/blog/SidebarWidget.vue";
import SidebarWidget from "~/components/blog/SidebarWidget.vue";

const defaultAvatar = "https://bro-world-space.com/img/person.png";

const reactionEmojis: Record<ReactionType, string> = {
  like: "üëç",
  love: "‚ù§Ô∏è",
  wow: "üòÆ",
  haha: "üòÇ",
  sad: "üò¢",
  angry: "üò°",
};

const { locale, t } = useI18n();

const reactionLabels = computed<Record<ReactionType, string>>(() => ({
  like: t("blog.reactions.reactionTypes.like"),
  love: t("blog.reactions.reactionTypes.love"),
  wow: t("blog.reactions.reactionTypes.wow"),
  haha: t("blog.reactions.reactionTypes.haha"),
  sad: t("blog.reactions.reactionTypes.sad"),
  angry: t("blog.reactions.reactionTypes.angry"),
}));

const { posts, pending, fetchPosts } = usePostsStore();
const heroContent = computed(() => ({
  eyebrow: t("blog.hero.eyebrow"),
  title: t("blog.hero.title"),
  description: t("blog.hero.description"),
  primary: {
    label: t("blog.hero.primaryAction"),
    href: "#latest",
  },
  secondary: {
    label: t("blog.hero.secondaryAction"),
    href: "https://bro-world.com/docs",
  },
}));
const heroStats = computed(() => {
  const communityPosts = posts.value ?? [];
  const totalReactions = communityPosts.reduce((total, post) => total + (post.reactions_count ?? 0), 0);
  const totalComments = communityPosts.reduce((total, post) => total + (post.totalComments ?? 0), 0);
  const activeMembers = new Set(communityPosts.map((post) => post.user?.id)).size;

  return [
    {
      id: "members",
      value: formatNumber(activeMembers),
      label: t("blog.hero.stats.members"),
    },
    {
      id: "reactions",
      value: formatNumber(totalReactions),
      label: t("blog.hero.stats.reactions"),
    },
    {
      id: "comments",
      value: formatNumber(totalComments),
      label: t("blog.hero.stats.comments"),
    },
  ];
});
const sidebarContent = computed(() => ({
  title: t("blog.sidebar.title"),
  subtitle: t("blog.sidebar.subtitle"),
  widgets: [
    {
      id: "community",
      icon: "ü§ù",
      title: t("blog.sidebar.widgets.community.title"),
      description: t("blog.sidebar.widgets.community.description"),
      action: {
        label: t("blog.sidebar.widgets.community.action"),
        href: "https://discord.gg/broworld",
        external: true,
      },
    },
    {
      id: "docs",
      icon: "üìò",
      title: t("blog.sidebar.widgets.docs.title"),
      description: t("blog.sidebar.widgets.docs.description"),
      action: {
        label: t("blog.sidebar.widgets.docs.action"),
        href: "https://bro-world.com/docs",
        external: true,
      },
    },
    {
      id: "contribute",
      icon: "üìù",
      title: t("blog.sidebar.widgets.contribute.title"),
      description: t("blog.sidebar.widgets.contribute.description"),
      action: {
        label: t("blog.sidebar.widgets.contribute.action"),
        href: "https://bro-world.com/contact",
        external: true,
      },
    },
  ] satisfies SidebarWidgetData[],
}));

function formatNumber(value: number | null | undefined) {
  return new Intl.NumberFormat(locale.value).format(value ?? 0);
}

await callOnce(() => fetchPosts());
</script>
